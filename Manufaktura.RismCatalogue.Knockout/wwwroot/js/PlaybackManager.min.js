var PlaybackManager=function(){var n=this;this.isPlaying=ko.observable(!1);this.currentMelodyId=ko.observable();this.stopToken=0;this.play=function(t){function e(n){var i,t;for(i in n)t=n[i],t.tagName==="line"||t.tagName==="path"?t.style.stroke=$(t).attr("previousColor")||"#000":t.style.fill=$(t).attr("previousColor")||"#000"}function h(n){var i,t;for(i in n)t=n[i],t.tagName==="line"||t.tagName==="path"?($(t).attr("previousColor",t.style.stroke),t.style.stroke="#c34853"):($(t).attr("previousColor",t.style.fill),t.style.fill="#c34853")}function c(n,t,i){if(n==null)return null;for(var r in n)if(n[r].id===t&&n[r].repetition===i)return n[r];return null}var s=$("#melody-"+t+" svg"),u,f,r,o,i;n.currentMelodyId(t);n.isPlaying(!0);n.stopToken++;u=n.stopToken;f=0;r=[];s.children().each(function(n,t){var a=$(t).attr("data-playback-start"),i,e,o,u,s,h,l;if(a!=null&&(i=a.split(" "),i!=null)){var v=$(t).attr("data-midi-pitch"),p=v?parseInt(v):null,y=$(t).attr("data-playback-duration");if(y!=null){e=parseInt(y);o=$(t).attr("id");for(u in i)s=parseInt(i[u]),h=c(r,o,u),h!=null?h.elements.push(t):(l={delayTime:s,pitch:p,duration:e,elements:[],id:o,repetition:u},l.elements.push(t),r.push(l),f=s+e)}}});for(o in r)i=r[o],setTimeout(function(t){return function(){if(n.stopToken!==u){e(t.elements);return}t.pitch!=null&&(MIDI.noteOn(0,t.pitch,127,0),MIDI.noteOff(0,t.pitch,t.duration*.001));h(t.elements)}}(i),i.delayTime),setTimeout(function(n){return function(){e(n.elements)}}(i),i.delayTime+i.duration);setTimeout(function(){n.stopToken===u&&n.isPlaying(!1)},f)};this.stop=function(){n.stopToken++;n.isPlaying(!1)}};